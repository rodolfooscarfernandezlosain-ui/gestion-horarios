<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <title>ğŸ“‹ GestiÃ³n de Novedades</title>
Â  <style>
Â  Â  body { font-family: Arial, sans-serif; margin: 20px; }
Â  Â  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
Â  Â  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
Â  Â  th { background-color: #f2f2f2; }
Â  Â  select, button { margin: 5px; padding: 6px; }
Â  </style>
</head>
<body>
Â  <h2>ğŸ“‹ Novedades del Personal</h2>

Â  <div>
Â  Â  <label>Mes:</label>
Â  Â  <select id="mes"></select>
Â  Â  <label>AÃ±o:</label>
Â  Â  <select id="anio"></select>
Â  Â  <label>Local:</label>
Â  Â  <select id="local"></select>
Â  Â  <label>Empleado:</label>
Â  Â  <select id="empleado"></select>
Â  Â  <button onclick="cargarNovedades()">ğŸ”„ Actualizar</button>
Â  Â  <button onclick="cerrarSesion()">ğŸ”“ Cerrar sesiÃ³n</button>
Â  </div>

Â  <table>
Â  Â  <thead>
Â  Â  Â  <tr>
Â  Â  Â  Â  <th>Empleado</th><th>Local</th><th>Horas Semanales</th><th>Horas Trabajadas</th>
Â  Â  Â  Â  <th>Extras</th><th>Nocturnas</th><th>Feriados</th><th>Domingos</th>
Â  Â  Â  Â  <th>Vacaciones Tomadas</th><th>Disponibles</th><th>Restantes</th>
Â  Â  Â  Â  <th>Licencias</th><th>Enfermedad</th>
Â  Â  Â  </tr>
Â  Â  </thead>
Â  Â  <tbody id="tablaNovedades"></tbody>
Â  </table>

Â  <script>
Â  Â  let empleados = [], ausencias = [], horariosEmpleados = [], feriados = [];
Â  Â  let usuarioGlobal = null;

Â  Â  async function verificarLogin() {
Â  Â  Â  const usuario = sessionStorage.getItem('usuario');
Â  Â  Â  if (usuario) return JSON.parse(usuario);

Â  Â  Â  const inputUsuario = prompt('ğŸ” Usuario:');
Â  Â  Â  if (!inputUsuario) return location.reload();

Â  Â  Â  const inputClave = prompt('ğŸ” ContraseÃ±a:');
Â  Â  Â  if (!inputClave) return location.reload();

Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch('https://gestion-personal-c9edd-default-rtdb.firebaseio.com/usuarios.json');
Â  Â  Â  Â  const usuarios = await res.json();
Â  Â  Â  Â  const user = Object.values(usuarios).find(u => u.usuario === inputUsuario && u.clave === inputClave);

Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  sessionStorage.setItem('usuario', JSON.stringify(user));
Â  Â  Â  Â  Â  return user;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert('âŒ Usuario o clave incorrectos');
Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  alert('âŒ Error al conectar con la base de datos');
Â  Â  Â  Â  console.error(error);
Â  Â  Â  }
Â  Â  }

Â  Â  function cerrarSesion() {
Â  Â  Â  sessionStorage.removeItem('usuario');
Â  Â  Â  location.reload();
Â  Â  }

Â  Â  function getLocalesUsuario() {
Â  Â  Â  if (usuarioGlobal.rol === 'admin') return null;
Â  Â  Â  return Array.isArray(usuarioGlobal.locales) ? usuarioGlobal.locales : [usuarioGlobal.locales].filter(l => l);
Â  Â  }

Â  Â  async function cargarDatos() {
Â  Â  Â  const urls = {
Â  Â  Â  Â  empleados: 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/empleados.json',
Â  Â  Â  Â  ausencias: 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/ausencias.json',
Â  Â  Â  Â  horarios: 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/horario_empleados.json',
Â  Â  Â  Â  feriados: 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/feriados.json'
Â  Â  Â  };

Â  Â  Â  const [e, a, h, f] = await Promise.all([
Â  Â  Â  Â  fetch(urls.empleados).then(r => r.json()),
Â  Â  Â  Â  fetch(urls.ausencias).then(r => r.json()),
Â  Â  Â  Â  fetch(urls.horarios).then(r => r.json()),
Â  Â  Â  Â  fetch(urls.feriados).then(r => r.json())
Â  Â  Â  ]);

Â  Â  Â  const localesPermitidos = getLocalesUsuario();
Â  Â  Â  empleados = Object.values(e).filter(emp => !localesPermitidos || localesPermitidos.includes(emp.local));
Â  Â  Â  ausencias = Object.values(a);
Â  Â  Â  horariosEmpleados = Object.values(h);
Â  Â  Â  feriados = Object.values(f);

Â  Â  Â  cargarFiltros();
Â  Â  }

Â  Â  function cargarFiltros() {
Â  Â  Â  const mesSelect = document.getElementById("mes");
Â  Â  Â  const anioSelect = document.getElementById("anio");
Â  Â  Â  const localSelect = document.getElementById("local");
Â  Â  Â  const empleadoSelect = document.getElementById("empleado");

Â  Â  Â  // Solo cargar Mes y AÃ±o la primera vez
Â  Â  Â  if (mesSelect.options.length === 0) {
Â  Â  Â  Â  mesSelect.innerHTML = [...Array(12).keys()].map(m => `<option value="${m+1}">${m+1}</option>`).join('');
Â  Â  Â  Â  const anioActual = new Date().getFullYear();
Â  Â  Â  Â  anioSelect.innerHTML = `<option>${anioActual}</option><option>${anioActual - 1}</option>`;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // Se rellenan los filtros de Local y Empleado
Â  Â  Â  const locales = [...new Set(empleados.map(e => e.local))];
Â  Â  Â  localSelect.innerHTML = `<option value="">Todos</option>` + locales.map(l => `<option>${l}</option>`).join('');

Â  Â  Â  empleadoSelect.innerHTML = `<option value="">Todos</option>` + empleados.map(e => `<option value="${e.key}">${e.nombre}</option>`).join('');
Â  Â  }

Â  Â  function cargarNovedades() {
Â  Â  Â  const mes = parseInt(document.getElementById("mes").value);
Â  Â  Â  const anio = parseInt(document.getElementById("anio").value);
Â  Â  Â  const localFiltro = document.getElementById("local").value;
Â  Â  Â  const empleadoFiltro = document.getElementById("empleado").value;

Â  Â  Â  if (!mes || !anio || isNaN(mes) || isNaN(anio)) {
Â  Â  Â  Â  alert("âš ï¸ SeleccionÃ¡ mes y aÃ±o vÃ¡lidos");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const tabla = document.getElementById("tablaNovedades");
Â  Â  Â  tabla.innerHTML = "";
      
      // *** AquÃ­ estÃ¡ el cambio clave: se crea una lista de empleados filtrada.
Â  Â  Â  const empleadosFiltrados = empleados.filter(emp => {
Â  Â  Â  Â  const cumpleLocal = !localFiltro || emp.local === localFiltro;
Â  Â  Â  Â  const cumpleEmpleado = !empleadoFiltro || emp.key === empleadoFiltro;
Â  Â  Â  Â  return cumpleLocal && cumpleEmpleado;
Â  Â  Â  });
      
Â  Â  Â  // Ahora se itera sobre la lista filtrada, no sobre todos los empleados.
Â  Â  Â  empleadosFiltrados.forEach(emp => {
Â  Â  Â  Â  const ausenciasEmp = ausencias.filter(a => a.empleadoKey === emp.key);
Â  Â  Â  Â  const horariosEmp = horariosEmpleados.filter(h => {
Â  Â  Â  Â  Â  const fecha = new Date(h.fecha);
Â  Â  Â  Â  Â  return h.empleadoKey === emp.key &&
Â  Â  Â  Â  Â  Â  Â  Â  Â fecha.getMonth() + 1 === mes &&
Â  Â  Â  Â  Â  Â  Â  Â  Â fecha.getFullYear() === anio;
Â  Â  Â  Â  });
Â  Â  Â  Â  const feriadosLocal = feriados.filter(f => f.local === emp.local);

Â  Â  Â  Â  const resumen = calcularResumen(emp, ausenciasEmp, horariosEmp, feriadosLocal);

Â  Â  Â  Â  const fila = document.createElement("tr");
Â  Â  Â  Â  fila.innerHTML = `
Â  Â  Â  Â  Â  <td>${emp.nombre}</td><td>${emp.local}</td><td>${emp.horasSemanales || 0}</td>
Â  Â  Â  Â  Â  <td>${resumen.horasTrabajadas}</td><td>${resumen.horasExtras}</td><td>${resumen.horasNocturnas}</td>
Â  Â  Â  Â  Â  <td>${resumen.feriadosTrabajados}</td><td>${resumen.domingosTrabajados}</td>
Â  Â  Â  Â  Â  <td>${resumen.vacacionesTomadas}</td><td>${resumen.vacacionesDisponibles}</td><td>${resumen.vacacionesRestantes}</td>
Â  Â  Â  Â  Â  <td>${resumen.licencias}</td><td>${resumen.enfermedad}</td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tabla.appendChild(fila);
Â  Â  Â  });

Â  Â  Â  if (tabla.rows.length === 0) {
Â  Â  Â  Â  const fila = document.createElement("tr");
Â  Â  Â  Â  fila.innerHTML = `<td colspan="13">âš ï¸ No se encontraron novedades para los filtros seleccionados</td>`;
Â  Â  Â  Â  tabla.appendChild(fila);
Â  Â  Â  }
Â  Â  }

Â  Â  function calcularResumen(emp, ausencias, horarios, feriados) {
Â  Â  Â  let horasTrabajadas = 0, horasExtras = 0, horasNocturnas = 0;
Â  Â  Â  let feriadosTrabajados = 0, domingosTrabajados = 0;
Â  Â  Â  let vacacionesTomadas = 0, vacacionesDisponibles = emp.vacaciones || 14;
Â  Â  Â  let licencias = 0, enfermedad = 0;

Â  Â  Â  horarios.forEach(h => {
Â  Â  Â  Â  horasTrabajadas += h.horas || 0;
Â  Â  Â  Â  if (h.extra) horasExtras += h.horas;
Â  Â  Â  Â  if (h.nocturno) horasNocturnas += h.horas;
Â  Â  Â  Â  if (h.dia === "domingo") domingosTrabajados++;
Â  Â  Â  Â  if (feriados.some(f => f.fecha === h.fecha)) feriadosTrabajados++;
Â  Â  Â  });

Â  Â  Â  ausencias.forEach(a => {
Â  Â  Â  Â  if (a.tipo === "vacaciones") vacacionesTomadas++;
Â  Â  Â  Â  if (a.tipo === "licencia") licencias++;
Â  Â  Â  Â  if (a.tipo === "enfermedad") enfermedad++;
Â  Â  Â  });

Â  Â  Â  const vacacionesRestantes = vacacionesDisponibles - vacacionesTomadas;

Â  Â  Â  return {
Â  Â  Â  Â  horasTrabajadas,
Â  Â  Â  Â  horasExtras,
Â  Â  Â  Â  horasNocturnas,
Â  Â  Â  Â  feriadosTrabajados,
Â  Â  Â  Â  domingosTrabajados,
Â  Â  Â  Â  vacacionesTomadas,
Â  Â  Â  Â  vacacionesDisponibles,
Â  Â  Â  Â  vacacionesRestantes,
Â  Â  Â  Â  licencias,
Â  Â  Â  Â  enfermedad
Â  Â  Â  };
Â  Â  }

Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  usuarioGlobal = await verificarLogin();
Â  Â  Â  if (usuarioGlobal) {
Â  Â  Â  Â  await cargarDatos();
Â  Â  Â  Â  cargarNovedades(); // Carga inicial con los filtros por defecto
Â  Â  Â  }
Â  Â  });
Â  </script>
</body>
</html>
