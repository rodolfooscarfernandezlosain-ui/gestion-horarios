<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novedades de Personal</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librerías para exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f4f6f9; 
            padding: 20px; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #2c3e50; 
            border-bottom: 2px solid #3498db; 
            padding-bottom: 10px; 
        }
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters input, .filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 4px; 
            cursor: pointer;
            margin-right: 8px;
        }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-pdf { background: #d32f2f; }
        .btn-excel { background: #1d6f42; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: center; 
        }
        th { 
            background: #ecf0f1; 
            font-weight: 600;
        }
        .info-box {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #3498db;
        }
        .snackbar { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: #27ae60; 
            color: white; 
            padding: 12px 20px; 
            border-radius: 6px; 
            z-index: 1000; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        .snackbar.show { 
            opacity: 1; 
        }
    </style>
</head>
<body>

    <!-- ✅ 1. VERIFICAR ACCESO Y PERMISOS -->
    <script>
        // Verificar login
        async function verificarLogin() {
            const usuario = sessionStorage.getItem('usuario');
            if (usuario) return JSON.parse(usuario);

            const inputUsuario = prompt('🔐 Usuario:');
            if (!inputUsuario) return location.reload();

            const inputClave = prompt('🔐 Contraseña:');
            if (!inputClave) return location.reload();

            try {
                const res = await fetch('https://gestion-personal-c9edd-default-rtdb.firebaseio.com/usuarios.json');
                if (!res.ok) throw new Error('Error en conexión');

                const usuarios = await res.json();
                const user = Object.values(usuarios).find(u => 
                    u.usuario === inputUsuario && u.clave === inputClave
                );

                if (user) {
                    sessionStorage.setItem('usuario', JSON.stringify(user));
                    return user;
                } else {
                    alert('❌ Usuario o clave incorrectos');
                    location.reload();
                    return null;
                }
            } catch (error) {
                alert('❌ Error al conectar con la base de datos');
                console.error(error);
                return null;
            }
        }

        // Verificar acceso
        function verificarAcceso() {
            const usuario = sessionStorage.getItem('usuario');
            if (!usuario) {
                alert('❌ Acceso denegado. Debe iniciar sesión.');
                window.location.href = 'index.html';
                return null;
            }
            return JSON.parse(usuario);
        }

        const usuarioGlobal = verificarAcceso();

        // Obtener locales del usuario
        function getLocalesUsuario() {
            if (usuarioGlobal.rol === 'admin') return null;
            return Array.isArray(usuarioGlobal.locales) 
                ? usuarioGlobal.locales 
                : [usuarioGlobal.locales].filter(l => l);
        }
    </script>

    <div class="container">
        <h1><i class="fas fa-clipboard-list"></i> Novedades de Personal</h1>

        <!-- Filtros -->
        <div class="filters">
            <div>
                <label>Local</label>
                <select id="filtro-local" onchange="filtrarNovedades()">
                    <option value="">Todos los locales</option>
                </select>
            </div>
            <div>
                <label>Empleado</label>
                <select id="filtro-empleado" onchange="filtrarNovedades()">
                    <option value="">Todos los empleados</option>
                </select>
            </div>
            <div>
                <label>Mes</label>
                <select id="filtro-mes" onchange="filtrarNovedades()">
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
            <div>
                <label>Año</label>
                <input type="number" id="filtro-anio" value="2025" min="2020" max="2030" oninput="filtrarNovedades()">
            </div>
            <button class="btn" onclick="cargarNovedades()">🔄 Actualizar</button>
        </div>

        <!-- Botones de exportación -->
        <div class="filters">
            <button class="btn-excel" onclick="exportarExcel()">
                <i class="fas fa-file-excel"></i> Exportar a Excel
            </button>
            <button class="btn-pdf" onclick="exportarPDF()">
                <i class="fas fa-file-pdf"></i> Exportar a PDF
            </button>
        </div>

        <!-- Información general -->
        <div class="info-box">
            <strong>Resumen del mes:</strong>
            <div id="resumen-mes">
                Total empleados: <span id="total-empleados">0</span> | 
                Horas extras: <span id="total-horas-extras">0</span> | 
                Feriados trabajados: <span id="total-feriados">0</span> | 
                Domingos trabajados: <span id="total-domingos">0</span>
            </div>
        </div>

        <!-- Tabla de novedades -->
        <div style="overflow-x: auto;">
            <table id="tabla-novedades">
                <thead>
                    <tr>
                        <th>Empleado</th>
                        <th>Local</th>
                        <th>Horas Semanales</th>
                        <th>Horas Trabajadas</th>
                        <th>Horas Extras</th>
                        <th>Feriados</th>
                        <th>Domingos</th>
                        <th>Vacaciones Tomadas</th>
                        <th>Vacaciones Acumuladas</th>
                        <th>Vacaciones Restantes</th>
                        <th>Licencias</th>
                        <th>Enfermedad</th>
                    </tr>
                </thead>
                <tbody id="body-novedades"></tbody>
            </table>
        </div>
    </div>

    <div id="snackbar" class="snackbar">Acción realizada</div>

    <script>
        // ✅ URLs de Firebase
        const DB_EMPLEADOS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/empleados.json';
        const DB_AUSENCIAS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/ausencias.json';
        const DB_HORARIOS_EMPLEADOS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/horarios_empleados.json';
        const DB_LOCALES = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/locales.json';

        let empleados = [];
        let ausencias = [];
        let horariosEmpleados = [];
        let locales = [];

        function showToast(msg, isError = false) {
            const sb = document.getElementById('snackbar');
            sb.textContent = msg;
            sb.className = 'snackbar show';
            if (isError) sb.classList.add('error');
            setTimeout(() => sb.className = 'snackbar', 3000);
        }

        // ✅ Cargar datos
        async function cargarDatos() {
            try {
                const [resEmp, resAus, resHor, resLoc] = await Promise.all([
                    fetch(DB_EMPLEADOS),
                    fetch(DB_AUSENCIAS),
                    fetch(DB_HORARIOS_EMPLEADOS),
                    fetch(DB_LOCALES)
                ]);

                const dataEmp = await resEmp.json();
                const dataAus = await resAus.json();
                const dataHor = await resHor.json();
                const dataLoc = await resLoc.json();

                empleados = Object.entries(dataEmp || {}).map(([key, value]) => ({ key, ...value }));
                ausencias = Object.values(dataAus || {});
                horariosEmpleados = Object.values(dataHor || {});
                locales = Object.values(dataLoc || {});

                // ✅ Filtrar empleados por local del usuario
                const localesUsuario = getLocalesUsuario();
                if (localesUsuario) {
                    empleados = empleados.filter(e => localesUsuario.includes(e.local));
                }

                // Cargar locales en filtro
                cargarLocales();
                cargarEmpleados();
                cargarNovedades();
            } catch (e) {
                console.error('Error cargando datos:', e);
                showToast('❌ Error al cargar datos', true);
            }
        }

        // ✅ Cargar locales
        function cargarLocales() {
            const select = document.getElementById('filtro-local');
            select.innerHTML = '<option value="">Todos los locales</option>';

            const localesUsuario = getLocalesUsuario();
            const localesFiltrados = localesUsuario ? locales.filter(l => localesUsuario.includes(l.nombre)) : locales;

            localesFiltrados.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc.nombre;
                opt.textContent = loc.nombre;
                select.appendChild(opt);
            });
        }

        // ✅ Cargar empleados en filtro
        function cargarEmpleados() {
            const select = document.getElementById('filtro-empleado');
            select.innerHTML = '<option value="">Todos los empleados</option>';

            empleados.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = emp.key;
                opt.textContent = emp.nombre;
                select.appendChild(opt);
            });
        }

        // ✅ Calcular horas trabajadas
        function calcularHorasTrabajadas(empleadoKey, mes, anio) {
            const horario = horariosEmpleados.find(h => h.empleadoKey === empleadoKey);
            if (!horario) return 0;

            const diasEnMes = new Date(anio, mes, 0).getDate();
            let horas = 0;

            for (let dia = 1; dia <= diasEnMes; dia++) {
                const fechaStr = `${anio}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const diaSemana = ['domingo','lunes','martes','miercoles','jueves','viernes','sabado'][new Date(fechaStr).getDay()];
                const diaData = horario.dias?.[diaSemana];

                if (diaData && !diaData.libre) {
                    // Horas turno 1
                    if (diaData.entrada && diaData.salida) {
                        const entrada = new Date(`2000-01-01 ${diaData.entrada}`);
                        const salida = new Date(`2000-01-01 ${diaData.salida}`);
                        horas += (salida - entrada) / (1000 * 60 * 60);
                    }
                    // Horas turno 2
                    if (diaData.doble && diaData.entrada2 && diaData.salida2) {
                        const entrada2 = new Date(`2000-01-01 ${diaData.entrada2}`);
                        const salida2 = new Date(`2000-01-01 ${diaData.salida2}`);
                        horas += (salida2 - entrada2) / (1000 * 60 * 60);
                    }
                }
            }
            return Math.round(horas * 10) / 10;
        }

        // ✅ Calcular horas extras
        function calcularHorasExtras(empleadoKey, mes, anio) {
            const emp = empleados.find(e => e.key === empleadoKey);
            if (!emp || !emp.horasSemanales) return 0;

            const horasTrabajadas = calcularHorasTrabajadas(empleadoKey, mes, anio);
            const semanas = new Date(anio, mes, 0).getDate() / 7;
            const horasNormales = emp.horasSemanales * semanas;

            return Math.max(0, Math.round((horasTrabajadas - horasNormales) * 10) / 10);
        }

        // ✅ Calcular feriados trabajados
        function calcularFeriadosTrabajados(empleadoKey, mes, anio) {
            const horario = horariosEmpleados.find(h => h.empleadoKey === empleadoKey);
            if (!horario) return 0;

            // Simulación: suponemos que hay 2 feriados en el mes
            const feriadosMes = [
                new Date(anio, mes - 1, 10),
                new Date(anio, mes - 1, 25)
            ];

            let feriadosTrabajados = 0;
            feriadosMes.forEach(feriado => {
                if (feriado.getMonth() === mes - 1 && feriado.getFullYear() === anio) {
                    const diaSemana = ['domingo','lunes','martes','miercoles','jueves','viernes','sabado'][feriado.getDay()];
                    const diaData = horario.dias?.[diaSemana];
                    if (diaData && !diaData.libre) {
                        feriadosTrabajados++;
                    }
                }
            });
            return feriadosTrabajados;
        }

        // ✅ Calcular domingos trabajados
        function calcularDomingosTrabajados(empleadoKey, mes, anio) {
            const horario = horariosEmpleados.find(h => h.empleadoKey === empleadoKey);
            if (!horario) return 0;

            const diasEnMes = new Date(anio, mes, 0).getDate();
            let domingos = 0;

            for (let dia = 1; dia <= diasEnMes; dia++) {
                const fechaStr = `${anio}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const diaSemana = new Date(fechaStr).getDay();
                if (diaSemana === 0) {
                    const diaData = horario.dias?.['domingo'];
                    if (diaData && !diaData.libre) {
                        domingos++;
                    }
                }
            }
            return domingos;
        }

        // ✅ Calcular vacaciones acumuladas
        function calcularVacacionesAcumuladas(empleadoKey) {
            const emp = empleados.find(e => e.key === empleadoKey);
            if (!emp || !emp.fechaIngreso) return 0;

            const fechaIngreso = new Date(emp.fechaIngreso);
            const hoy = new Date();
            const diffTime = Math.abs(hoy - fechaIngreso);
            const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365);

            // 14 días por año completo
            return Math.floor(diffYears * 14);
        }

        // ✅ Calcular vacaciones tomadas en el mes
        function calcularVacacionesTomadas(empleadoKey, mes, anio) {
            return ausencias.filter(a => 
                a.empleadoKey === empleadoKey && 
                a.tipo === 'vacaciones' &&
                new Date(a.fechaInicio).getMonth() + 1 === mes &&
                new Date(a.fechaInicio).getFullYear() === anio
            ).length;
        }

        // ✅ Calcular vacaciones restantes
        function calcularVacacionesRestantes(empleadoKey) {
            const acumuladas = calcularVacacionesAcumuladas(empleadoKey);
            const tomadas = ausencias.filter(a => 
                a.empleadoKey === empleadoKey && 
                a.tipo === 'vacaciones'
            ).length;
            return Math.max(0, acumuladas - tomadas);
        }

        // ✅ Calcular licencias
        function contarLicencias(empleadoKey, mes, anio) {
            return ausencias.filter(a => 
                a.empleadoKey === empleadoKey && 
                a.tipo === 'licencia' &&
                new Date(a.fechaInicio).getMonth() + 1 === mes &&
                new Date(a.fechaInicio).getFullYear() === anio
            ).length;
        }

        // ✅ Calcular enfermedad
        function contarEnfermedad(empleadoKey, mes, anio) {
            return ausencias.filter(a => 
                a.empleadoKey === empleadoKey && 
                a.tipo === 'enfermedad' &&
                new Date(a.fechaInicio).getMonth() + 1 === mes &&
                new Date(a.fechaInicio).getFullYear() === anio
            ).length;
        }

        // ✅ Generar novedades
        function cargarNovedades() {
            const localFiltro = document.getElementById('filtro-local').value;
            const empleadoFiltro = document.getElementById('filtro-empleado').value;
            const mes = parseInt(document.getElementById('filtro-mes').value);
            const anio = parseInt(document.getElementById('filtro-anio').value);

            const tbody = document.getElementById('body-novedades');
            tbody.innerHTML = '';

            // Filtrar empleados
            let empleadosFiltrados = empleados;
            if (localFiltro) {
                empleadosFiltrados = empleadosFiltrados.filter(e => e.local === localFiltro);
            }
            if (empleadoFiltro) {
                empleadosFiltrados = empleadosFiltrados.filter(e => e.key === empleadoFiltro);
            }

            if (empleadosFiltrados.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="12" style="text-align:center">No hay empleados para mostrar</td>`;
                tbody.appendChild(tr);
                return;
            }

            // Variables para resumen
            let totalHorasExtras = 0;
            let totalFeriados = 0;
            let totalDomingos = 0;

            // Generar filas
            empleadosFiltrados.forEach(emp => {
                const horasSemanales = emp.horasSemanales || '—';
                const horasTrabajadas = calcularHorasTrabajadas(emp.key, mes, anio);
                const horasExtras = calcularHorasExtras(emp.key, mes, anio);
                const feriados = calcularFeriadosTrabajados(emp.key, mes, anio);
                const domingos = calcularDomingosTrabajados(emp.key, mes, anio);
                const vacacionesTomadas = calcularVacacionesTomadas(emp.key, mes, anio);
                const vacacionesAcumuladas = calcularVacacionesAcumuladas(emp.key);
                const vacacionesRestantes = calcularVacacionesRestantes(emp.key);
                const licencias = contarLicencias(emp.key, mes, anio);
                const enfermedad = contarEnfermedad(emp.key, mes, anio);

                totalHorasExtras += horasExtras;
                totalFeriados += feriados;
                totalDomingos += domingos;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${emp.nombre}</strong></td>
                    <td>${emp.local}</td>
                    <td>${horasSemanales}</td>
                    <td>${horasTrabajadas}</td>
                    <td><strong>${horasExtras}</strong></td>
                    <td>${feriados}</td>
                    <td>${domingos}</td>
                    <td>${vacacionesTomadas}</td>
                    <td>${vacacionesAcumuladas}</td>
                    <td><strong>${vacacionesRestantes}</strong></td>
                    <td>${licencias}</td>
                    <td>${enfermedad}</td>
                `;
                tbody.appendChild(tr);
            });

            // Actualizar resumen
            document.getElementById('total-empleados').textContent = empleadosFiltrados.length;
            document.getElementById('total-horas-extras').textContent = Math.round(totalHorasExtras * 10) / 10;
            document.getElementById('total-feriados').textContent = totalFeriados;
            document.getElementById('total-domingos').textContent = totalDomingos;
        }

        // ✅ Filtrar novedades
        function filtrarNovedades() {
            setTimeout(cargarNovedades, 100);
        }

        // ✅ Exportar a Excel
        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([]);

            const mes = parseInt(document.getElementById('filtro-mes').value);
            const anio = parseInt(document.getElementById('filtro-anio').value);
            const nombreMes = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][mes-1];

            // Encabezado
            XLSX.utils.sheet_add_aoa(ws, [[`NOVEDADES - ${nombreMes} ${anio}`]], {origin: 'A1'});
            XLSX.utils.sheet_add_aoa(ws, [[]], {origin: 'A2'});

            const headers = [['Empleado','Local','Horas Semanales','Horas Trab.','Horas Extras','Feriados','Domingos','Vac. Tomadas','Vac. Acumuladas','Vac. Restantes','Licencias','Enfermedad']];
            XLSX.utils.sheet_add_aoa(ws, headers, {origin: 'A3'});

            // Datos
            const tbody = document.getElementById('body-novedades');
            const rows = tbody.querySelectorAll('tr');
            const data = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                data.push(rowData);
            });

            XLSX.utils.sheet_add_aoa(ws, data, {origin: 'A4'});
            XLSX.utils.book_append_sheet(wb, ws, 'Novedades');
            XLSX.writeFile(wb, `novedades_${mes}_${anio}.xlsx`);
            showToast('✅ Exportado a Excel');
        }

        // ✅ Exportar a PDF
        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const mes = parseInt(document.getElementById('filtro-mes').value);
            const anio = parseInt(document.getElementById('filtro-anio').value);
            const nombreMes = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][mes-1];

            doc.setFontSize(16);
            doc.text(`NOVEDADES - ${nombreMes} ${anio}`, 14, 10);

            // Datos para la tabla
            const headers = [['Empleado','Local','H.Sem','H.Trab','H.Extras','Fer','Dom','V.Tom','V.Acu','V.Res','Lic','Enf']];
            const data = [];

            const tbody = document.getElementById('body-novedades');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                data.push(rowData);
            });

            doc.autoTable({
                head: headers,
                body: data,
                startY: 20,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 25 } }
            });

            doc.save(`novedades_${mes}_${anio}.pdf`);
            showToast('✅ Exportado a PDF');
        }

        // Inicializar
        window.onload = async function () {
            await cargarDatos();
        };
    </script>

    <!-- ✅ Botón flotante -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('btn-menu-flotante')) return;
            const btn = document.createElement('button');
            btn.id = 'btn-menu-flotante';
            btn.textContent = '☰ Menú';
            btn.title = 'Volver al menú principal';
            btn.style.cssText = `
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                z-index: 99999 !important;
                padding: 12px 16px !important;
                font-size: 14px !important;
                font-weight: bold !important;
                color: white !important;
                background-color: #2980b9 !important;
                border: none !important;
                border-radius: 6px !important;
                box-shadow: 0 3px 8px rgba(0,0,0,0.3) !important;
                cursor: pointer !important;
                opacity: 1 !important;
                display: block !important;
                transition: all 0.2s ease !important;
            `;
            btn.onclick = () => {
                window.location.href = 'index.html';
            };
            document.body.appendChild(btn);
        });
    </script>
</body>
</html>
