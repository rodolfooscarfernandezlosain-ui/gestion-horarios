<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Novedades</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f4f6f9; 
            padding: 20px; 
            margin: 0;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #2c3e50; 
            border-bottom: 2px solid #3498db; 
            padding-bottom: 10px; 
        }
        .form-group { 
            margin: 15px 0; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
        }
        input, select, button { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left; 
        }
        th { 
            background: #ecf0f1; 
            text-align: center;
        }
        .dias-restantes { 
            font-weight: bold; 
            color: #27ae60; 
        }
        .dias-usados { 
            color: #e74c3c; 
        }
        .snackbar { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: #27ae60; 
            color: white; 
            padding: 12px 20px; 
            border-radius: 6px; 
            z-index: 1000; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        .snackbar.show { 
            opacity: 1; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-clipboard-list"></i> Gestión de Novedades y Vacaciones</h1>

        <div class="form-group">
            <label>Filtrar por Mes/Año</label>
            <input type="month" id="filtro-mes" onchange="filtrarNovedades()">
        </div>

        <table id="tabla-novedades">
            <thead>
                <tr>
                    <th>Legajo</th>
                    <th>Nombre</th>
                    <th>Fecha Ingreso</th>
                    <th>Antigüedad</th>
                    <th>Vacaciones</th>
                    <th>Tomados</th>
                    <th>Restantes</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="snackbar" class="snackbar">Acción realizada</div>

    <script>
        // ✅ URLs de Firebase (sin espacios)
        const DB_EMPLEADOS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/empleados.json';
        const DB_NOVEDADES = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/novedades.json';

        let empleados = [];
        let novedades = [];

        function showToast(msg, isError = false) {
            const sb = document.getElementById('snackbar');
            sb.textContent = msg;
            sb.className = 'snackbar show';
            if (isError) sb.classList.add('error');
            setTimeout(() => sb.className = 'snackbar', 3000);
        }

        // ✅ Calcular antigüedad en años
        function calcularAntiguedad(fechaIngreso) {
            const hoy = new Date();
            const ingreso = new Date(fechaIngreso);
            const diff = hoy - ingreso;
            return Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
        }

        // ✅ Calcular días de vacaciones según antigüedad
        function diasVacaciones(antiguedad) {
            if (antiguedad < 5) return 14;
            if (antiguedad < 10) return 21;
            if (antiguedad < 20) return 28;
            return 35;
        }

        // ✅ Cargar empleados
        async function cargarEmpleados() {
            try {
                const res = await fetch(DB_EMPLEADOS);
                const data = await res.json();
                empleados = data ? Object.values(data) : [];
            } catch (e) {
                console.error('Error cargando empleados:', e);
                showToast('❌ Error al cargar empleados', true);
            }
        }

        // ✅ Cargar novedades
        async function cargarNovedades() {
            try {
                const res = await fetch(DB_NOVEDADES);
                const data = await res.json();
                novedades = data ? Object.values(data) : [];
            } catch (e) {
                console.error('Error cargando novedades:', e);
                showToast('❌ Error al cargar novedades', true);
            }
        }

        // ✅ Guardar novedad
        async function guardarNovedad(novedad) {
            try {
                const res = await fetch(DB_NOVEDADES, {
                    method: 'POST',
                    body: JSON.stringify(novedad),
                    headers: { 'Content-Type': 'application/json' }
                });
                if (res.ok) {
                    await cargarNovedades();
                }
            } catch (e) {
                console.error('Error guardando novedad:', e);
            }
        }

        // ✅ Filtrar y mostrar novedades
        function filtrarNovedades() {
            const filtro = document.getElementById('filtro-mes').value; // formato "YYYY-MM"
            const tbody = document.querySelector('#tabla-novedades tbody');
            tbody.innerHTML = '';

            empleados.forEach(emp => {
                if (!emp.fechaIngreso) return;

                const antiguedad = calcularAntiguedad(emp.fechaIngreso);
                const diasTotales = diasVacaciones(antiguedad);

                // Filtrar novedades del mes
                const mesFiltro = filtro ? new Date(filtro + '-01') : null;
                const novedadesMes = novedades.filter(n => 
                    n.empleadoLegajo === emp.legajo && 
                    n.tipo === 'Vacaciones' &&
                    (!mesFiltro || new Date(n.fechaInicio).getMonth() === mesFiltro.getMonth() &&
                     new Date(n.fechaInicio).getFullYear() === mesFiltro.getFullYear())
                );

                const diasTomados = novedadesMes.reduce((acc, n) => {
                    const inicio = new Date(n.fechaInicio);
                    const fin = new Date(n.fechaFin);
                    const diff = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
                    return acc + diff;
                }, 0);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${emp.legajo}</td>
                    <td>${emp.nombre}</td>
                    <td>${new Date(emp.fechaIngreso).toLocaleDateString('es-AR')}</td>
                    <td>${antiguedad} año(s)</td>
                    <td>${diasTotales} días</td>
                    <td class="dias-usados">${diasTomados} días</td>
                    <td class="dias-restantes">${diasTotales - diasTomados} días</td>
                    <td>
                        <button onclick="registrarVacaciones('${emp.legajo}')">➕ Tomar Vacaciones</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ✅ Registrar vacaciones
        function registrarVacaciones(legajo) {
            const dias = prompt('¿Cuántos días de vacaciones tomó el empleado?');
            if (!dias || isNaN(dias) || dias <= 0) {
                showToast('⚠️ Ingresa un número válido', true);
                return;
            }

            const fechaInicio = prompt('Fecha de inicio (YYYY-MM-DD):');
            const fechaFin = prompt('Fecha de fin (YYYY-MM-DD):');

            if (!fechaInicio || !fechaFin) {
                showToast('⚠️ Completa las fechas', true);
                return;
            }

            const novedad = {
                empleadoLegajo: legajo,
                tipo: 'Vacaciones',
                dias: parseInt(dias),
                fechaInicio,
                fechaFin,
                fechaRegistro: new Date().toISOString().split('T')[0]
            };

            guardarNovedad(novedad);
            showToast('✅ Vacaciones registradas');
            filtrarNovedades();
        }

        // Inicializar
        window.onload = async function () {
            await cargarEmpleados();
            await cargarNovedades();
            document.getElementById('filtro-mes').value = new Date().toISOString().slice(0, 7);
            filtrarNovedades();
        };
    </script>

    <!-- ✅ Botón flotante -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('btn-menu-flotante')) return;
            const btn = document.createElement('button');
            btn.id = 'btn-menu-flotante';
            btn.textContent = '☰ Menú';
            btn.title = 'Volver al menú principal';
            btn.style.cssText = `
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                z-index: 99999 !important;
                padding: 12px 16px !important;
                font-size: 14px !important;
                font-weight: bold !important;
                color: white !important;
                background-color: #2980b9 !important;
                border: none !important;
                border-radius: 6px !important;
                box-shadow: 0 3px 8px rgba(0,0,0,0.3) !important;
                cursor: pointer !important;
                opacity: 1 !important;
                display: block !important;
                transition: all 0.2s ease !important;
            `;
            btn.onclick = () => {
                window.location.href = 'https://rodolfooscarfernandezlosain-ui.github.io/gestion-horarios/';
            };
            document.body.appendChild(btn);
        });
    </script>
</body>
</html>
