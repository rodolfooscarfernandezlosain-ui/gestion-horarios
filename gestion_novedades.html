<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novedades Mensuales</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f4f6f9; 
            padding: 20px; 
            margin: 0;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #2c3e50; 
            border-bottom: 2px solid #3498db; 
            padding-bottom: 10px; 
        }
        .form-group { 
            margin: 15px 0; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
        }
        select, input { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            text-align: left; 
            font-size: 0.95rem;
        }
        th { 
            background: #ecf0f1; 
            text-align: center;
            position: sticky;
            top: 0;
        }
        .destacado { 
            font-weight: bold; 
            color: #27ae60; 
        }
        .ausencia { 
            color: #e74c3c; 
            font-weight: bold; 
        }
        .extra { 
            background: #f39c12; 
            color: white; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.85rem; 
        }
        .snackbar { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: #27ae60; 
            color: white; 
            padding: 12px 20px; 
            border-radius: 6px; 
            z-index: 1000; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        .snackbar.show { 
            opacity: 1; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-calendar-alt"></i> Novedades Mensuales</h1>

        <div class="form-group">
            <div>
                <label>Local</label>
                <select id="filtro-local" onchange="cargarNovedades()">
                    <option value="">Todos los locales</option>
                </select>
            </div>
            <div>
                <label>Mes/A√±o</label>
                <input type="month" id="filtro-mes" onchange="cargarNovedades()">
            </div>
        </div>

        <table id="tabla-novedades">
            <thead>
                <tr>
                    <th>Legajo</th>
                    <th>Nombre</th>
                    <th>Local</th>
                    <th>Antig√ºedad</th>
                    <th>Vac. Disp.</th>
                    <th>Vac. Tom.</th>
                    <th>Rest.</th>
                    <th>Trab.</th>
                    <th>Extras</th>
                    <th>Feriados</th>
                    <th>Otros</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="snackbar" class="snackbar">Datos cargados</div>

    <script>
        // ‚úÖ URLs de Firebase (SIN espacios)
        const DB_EMPLEADOS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/empleados.json';
        const DB_LOCALES = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/locales.json';
        const DB_HORARIOS_EMPLEADOS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/horarios_empleados.json';
        const DB_AUSENCIAS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/ausencias.json';
        const DB_FERIADOS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/feriados.json';

        let empleados = [];
        let locales = [];
        let horariosEmpleados = [];
        let ausencias = [];
        let feriados = [];

        function showToast(msg) {
            const sb = document.getElementById('snackbar');
            sb.textContent = msg;
            sb.className = 'snackbar show';
            setTimeout(() => sb.className = 'snackbar', 3000);
        }

        // ‚úÖ Calcular antig√ºedad
        function calcularAntiguedad(fechaIngreso) {
            if (!fechaIngreso) return 0;
            const hoy = new Date();
            const ingreso = new Date(fechaIngreso);
            if (isNaN(ingreso.getTime())) return 0;
            const diff = hoy - ingreso;
            return Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
        }

        // ‚úÖ D√≠as de vacaciones seg√∫n antig√ºedad
        function diasVacaciones(antiguedad) {
            if (antiguedad < 5) return 14;
            if (antiguedad < 10) return 21;
            if (antiguedad < 20) return 28;
            return 35;
        }

        // ‚úÖ Convertir fecha string a objeto Date seguro
        function parseFecha(fechaStr) {
            if (!fechaStr) return null;
            // Formatos comunes: "2025-10-15", "15/10/2025", "2025-10-15T00:00:00"
            const fecha = new Date(fechaStr);
            return isNaN(fecha.getTime()) ? null : fecha;
        }

        // ‚úÖ Cargar todos los datos
        async function cargarDatos() {
            try {
                const [dataEmp, dataLoc, dataHorarios, dataAusencias, dataFeriados] = await Promise.all([
                    fetch(DB_EMPLEADOS).then(r => r.json()),
                    fetch(DB_LOCALES).then(r => r.json()),
                    fetch(DB_HORARIOS_EMPLEADOS).then(r => r.json()),
                    fetch(DB_AUSENCIAS).then(r => r.json()),
                    fetch(DB_FERIADOS).then(r => r.json())
                ]);

                empleados = dataEmp ? Object.values(dataEmp) : [];
                locales = dataLoc ? Object.values(dataLoc) : [];
                horariosEmpleados = dataHorarios ? Object.values(dataHorarios) : [];
                ausencias = dataAusencias ? Object.values(dataAusencias) : [];
                feriados = dataFeriados ? Object.values(dataFeriados) : [];

                console.log('‚úÖ Datos cargados:', { empleados, ausencias, feriados });

                cargarLocales();
                document.getElementById('filtro-mes').value = new Date().toISOString().slice(0, 7);
                cargarNovedades();
            } catch (e) {
                console.error('‚ùå Error cargando datos:', e);
                showToast('Error al cargar datos. Revisa la consola.', true);
            }
        }

        // ‚úÖ Cargar locales
        function cargarLocales() {
            const select = document.getElementById('filtro-local');
            select.innerHTML = '<option value="">Todos los locales</option>';
            locales.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc.nombre;
                opt.textContent = loc.nombre;
                select.appendChild(opt);
            });
        }

        // ‚úÖ Cargar novedades
        function cargarNovedades() {
            const localFiltro = document.getElementById('filtro-local').value;
            const mesAnio = document.getElementById('filtro-mes').value;
            if (!mesAnio) return;

            const [year, month] = mesAnio.split('-').map(Number); // month es 0-indexado: enero=0, octubre=9

            const tbody = document.querySelector('#tabla-novedades tbody');
            tbody.innerHTML = '';

            const empleadosFiltrados = localFiltro 
                ? empleados.filter(e => e.local === localFiltro) 
                : empleados;

            empleadosFiltrados.forEach(emp => {
                if (!emp.fechaIngreso) return;

                const antiguedad = calcularAntiguedad(emp.fechaIngreso);
                const vacacionesTotales = diasVacaciones(antiguedad);

                // üèñÔ∏è Vacaciones tomadas en el mes
                const ausenciasMes = ausencias.filter(a => {
                    if (a.empleadoLegajo !== emp.legajo || a.tipo !== 'Vacaciones') return false;
                    const fechaInicio = parseFecha(a.fechaInicio);
                    return fechaInicio && fechaInicio.getMonth() === month && fechaInicio.getFullYear() === year;
                });

                const diasVacacionesTomados = ausenciasMes.reduce((acc, a) => {
                    const inicio = parseFecha(a.fechaInicio);
                    const fin = parseFecha(a.fechaFin);
                    if (!inicio || !fin) return acc;
                    return acc + Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
                }, 0);

                // üìÖ D√≠as trabajados y horas extras
                const horarioEmp = horariosEmpleados.find(h => h.empleadoKey === emp.key);
                let diasTrabajados = 0;
                let horasExtras = 0;

                if (horarioEmp && horarioEmp.dias) {
                    const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
                    const ultimoDia = new Date(year, month + 1, 0);
                    const diasDelMes = ultimoDia.getDate();

                    for (let dia = 1; dia <= diasDelMes; dia++) {
                        const fecha = new Date(year, month, dia);
                        const diaSemana = dias[fecha.getDay()];
                        const horario = horarioEmp.dias[diaSemana];

                        if (horario && !horario.libre) {
                            diasTrabajados++;
                            horasExtras += 2; // Ajusta seg√∫n tu l√≥gica
                        }
                    }
                }

                // üéâ Feriados trabajados
                const feriadosMes = feriados.filter(f => {
                    const fecha = parseFecha(f.fecha);
                    return fecha && fecha.getMonth() === month && fecha.getFullYear() === year;
                }).length;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${emp.legajo}</td>
                    <td>${emp.nombre}</td>
                    <td><strong>${emp.local}</strong></td>
                    <td>${antiguedad} a√±os</td>
                    <td class="destacado">${vacacionesTotales}</td>
                    <td class="ausencia">${diasVacacionesTomados}</td>
                    <td class="destacado">${vacacionesTotales - diasVacacionesTomados}</td>
                    <td>${diasTrabajados}</td>
                    <td><span class="extra">${horasExtras}h</span></td>
                    <td>${feriadosMes}</td>
                    <td>-</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Inicializar
        window.onload = async function () {
            await cargarDatos();
        };
    </script>

    <!-- ‚úÖ Bot√≥n flotante -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('btn-menu-flotante')) return;
            const btn = document.createElement('button');
            btn.id = 'btn-menu-flotante';
            btn.textContent = '‚ò∞ Men√∫';
            btn.title = 'Volver al men√∫ principal';
            btn.style.cssText = `
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                z-index: 99999 !important;
                padding: 12px 16px !important;
                font-size: 14px !important;
                font-weight: bold !important;
                color: white !important;
                background-color: #2980b9 !important;
                border: none !important;
                border-radius: 6px !important;
                box-shadow: 0 3px 8px rgba(0,0,0,0.3) !important;
                cursor: pointer !important;
                opacity: 1 !important;
                display: block !important;
                transition: all 0.2s ease !important;
            `;
            btn.onclick = () => {
                window.location.href = 'https://rodolfooscarfernandezlosain-ui.github.io/gestion-horarios/';
            };
            document.body.appendChild(btn);
        });
    </script>
</body>
</html>
