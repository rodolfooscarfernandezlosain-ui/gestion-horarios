<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horarios por Local</title>
    <!-- Font Awesome sin espacios -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .day-group { margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 6px; border: 1px solid #eee; }
        .toggle-row { display: flex; gap: 10px; margin: 5px 0; }
        .time-row { display: flex; gap: 10px; margin: 5px 0; align-items: center; }
        .time-row input, .time-row select { flex: 1; }
        .pico-group { margin: 10px 0; padding: 10px; background: #e8f4fc; border-radius: 6px; border: 1px dashed #3498db; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #ecf0f1; }
        .snackbar { position: fixed; bottom: 20px; right: 20px; background: #27ae60; color: white; padding: 12px 20px; border-radius: 6px; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
        .snackbar.show { opacity: 1; }
        .error { background: #e74c3c !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-clock"></i> Configuración de Horarios por Local</h1>

        <form id="form-horario">
            <input type="hidden" id="edit-key" value="">

            <div class="form-group">
                <label>Nombre del Local *</label>
                <input type="text" id="local-nombre" placeholder="Ej: Sucursal Centro" required>
            </div>

            <div id="dias-container"></div>

            <button type="submit" class="btn">
                <i class="fas fa-save"></i> <span id="btn-texto">Guardar Configuración</span>
            </button>
            <button type="button" onclick="limpiarFormulario()" style="background:#95a5a6; margin-left:10px;">
                Cancelar
            </button>
        </form>

        <table id="tabla-horarios">
            <thead>
                <tr>
                    <th>Local</th>
                    <th>Lunes</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="snackbar" class="snackbar">Acción realizada</div>

    <script>
        // ✅ URLs de Firebase (sin espacios)
        const DB_URL = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/horarios_locales.json';
        const DB_CATEGORIAS = 'https://gestion-personal-c9edd-default-rtdb.firebaseio.com/categorias.json';

        let categorias = [];

        function showToast(msg, isError = false) {
            const sb = document.getElementById('snackbar');
            sb.textContent = msg;
            sb.className = 'snackbar show';
            if (isError) sb.classList.add('error');
            setTimeout(() => sb.className = 'snackbar', 3000);
        }

        // Cargar categorías (puestos)
        async function cargarCategorias() {
            try {
                const res = await fetch(DB_CATEGORIAS);
                const data = await res.json();
                categorias = data ? Object.entries(data).map(([key, value]) => ({ key, ...value })) : [];
            } catch (e) {
                console.error('Error cargando categorías:', e);
                showToast('⚠️ No se cargaron los puestos', true);
            }
        }

        // Generar HTML para un día
        function generarDiaHTML(dia) {
            return `
                <div class="day-group" data-dia="${dia}">
                    <h3>${dia.charAt(0).toUpperCase() + dia.slice(1)}</h3>

                    <div class="toggle-row">
                        <label><input type="checkbox" class="chk-continuo"> Horario Continuo</label>
                        <label><input type="checkbox" class="chk-doble"> Turno Doble</label>
                    </div>

                    <div class="time-row">
                        <input type="time" class="hora-apertura" required>
                        <input type="time" class="hora-cierre" required>
                    </div>

                    <div class="time-row doble-horario" style="display:none;">
                        <input type="time" class="hora-apertura2">
                        <input type="time" class="hora-cierre2">
                    </div>

                    <div class="pico-group pico-simple" style="display:none;">
                        <h4>Horario Pico (Mayor Venta)</h4>
                        <div class="time-row">
                            <input type="time" class="pico-inicio">
                            <input type="time" class="pico-fin">
                        </div>
                        <div class="puestos-container"></div>
                    </div>

                    <div class="pico-group pico-extra" style="display:none;">
                        <h4>Segundo Horario Pico (Mayor Venta)</h4>
                        <div class="time-row">
                            <input type="time" class="pico-extra-inicio">
                            <input type="time" class="pico-extra-fin">
                        </div>
                        <div class="puestos-extra-container"></div>
                    </div>
                </div>
            `;
        }

        // Inicializar días
        async function inicializarDias() {
            const container = document.getElementById('dias-container');
            const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            container.innerHTML = '';
            dias.forEach(dia => container.innerHTML += generarDiaHTML(dia));

            await cargarCategorias();

            document.querySelectorAll('.chk-continuo').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const group = this.closest('.day-group');
                    group.querySelector('.pico-simple').style.display = this.checked ? 'block' : 'none';
                    actualizarPuestos(group, '.puestos-container');
                });
            });

            document.querySelectorAll('.chk-doble').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const group = this.closest('.day-group');
                    group.querySelector('.doble-horario').style.display = this.checked ? 'flex' : 'none';
                });
            });

            // Detectar si supera 14h
            document.querySelectorAll('.pico-simple').forEach(group => {
                group.addEventListener('input', () => {
                    const inicio = group.querySelector('.pico-inicio').value;
                    const fin = group.querySelector('.pico-fin').value;
                    if (inicio && fin) {
                        const horas = (new Date(`2020-01-01T${fin}`) - new Date(`2020-01-01T${inicio}`)) / 3600000;
                        group.closest('.day-group').querySelector('.pico-extra').style.display = horas > 14 ? 'block' : 'none';
                        actualizarPuestos(group.closest('.day-group'), '.puestos-extra-container');
                    }
                });
            });
        }

        // Actualizar puestos
        function actualizarPuestos(group, selector) {
            const container = group.querySelector(selector);
            if (!container) return;
            container.innerHTML = '';
            categorias.forEach(cat => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div style="display:flex; gap:10px; margin:5px 0;">
                        <select style="flex:2;">
                            <option value="${cat.nombre}">${cat.puesto}</option>
                        </select>
                        <input type="number" placeholder="Cantidad" min="1" style="flex:1;" value="1">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Guardar horario
        async function guardarHorario(e) {
            e.preventDefault();
            const local = document.getElementById('local-nombre').value.trim();
            if (!local) return showToast('⚠️ Nombre del local', true);

            const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            const data = { local };

            let valido = true;

            dias.forEach(dia => {
                const group = document.querySelector(`[data-dia="${dia}"]`);
                const apertura = group.querySelector('.hora-apertura').value;
                const cierre = group.querySelector('.hora-cierre').value;

                if (!apertura || !cierre) {
                    valido = false;
                    return;
                }

                data[dia] = {
                    apertura,
                    cierre,
                    doble: group.querySelector('.chk-doble').checked,
                    continuo: group.querySelector('.chk-continuo').checked
                };

                // Guardar puestos del primer pico
                const puestosCont = group.querySelector('.puestos-container');
                if (puestosCont && data[dia].continuo) {
                    const puestos = [];
                    puestosCont.querySelectorAll('select').forEach((sel, i) => {
                        const input = puestosCont.querySelectorAll('input')[i];
                        puestos.push({
                            puesto: sel.value,
                            puestoNombre: sel.options[sel.selectedIndex].text,
                            cantidad: input.value
                        });
                    });
                    data[dia].puestos_pico = puestos;
                }

                // Guardar puestos del segundo pico (si >14h)
                const puestosExtraCont = group.querySelector('.puestos-extra-container');
                if (puestosExtraCont && group.querySelector('.pico-extra').style.display === 'block') {
                    const puestosExtra = [];
                    puestosExtraCont.querySelectorAll('select').forEach((sel, i) => {
                        const input = puestosExtraCont.querySelectorAll('input')[i];
                        puestosExtra.push({
                            puesto: sel.value,
                            puestoNombre: sel.options[sel.selectedIndex].text,
                            cantidad: input.value
                        });
                    });
                    data[dia].puestos_pico_extra = puestosExtra;
                }
            });

            if (!valido) {
                showToast('⚠️ Completa todos los campos', true);
                return;
            }

            try {
                const res = await fetch(DB_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });

                if (res.ok) {
                    showToast('✅ Configuración guardada');
                    await cargarHorarios();
                } else {
                    throw new Error('Error al guardar');
                }
            } catch (err) {
                console.error(err);
                showToast('❌ Error al guardar', true);
            }
        }

        // Cargar horarios
        async function cargarHorarios() {
            try {
                const res = await fetch(DB_URL);
                const data = await res.json();
                const horarios = data ? Object.entries(data).map(([k,v]) => ({k, ...v })) : [];
                const tbody = document.querySelector('#tabla-horarios tbody');
                tbody.innerHTML = horarios.length ? 
                    horarios.map(h => `<tr><td>${h.local}</td><td>Lunes</td><td><button onclick="eliminar('${h.k}')">Eliminar</button></td></tr>`).join('') :
                    '<tr><td colspan="3">No hay datos</td></tr>';
            } catch (e) {
                console.error(e);
                showToast('❌ Error al cargar horarios', true);
            }
        }

        async function eliminar(key) {
            if (!confirm('¿Eliminar esta configuración?')) return;
            await fetch(`${DB_URL.replace('.json', `/${key}.json`)}`, { method: 'DELETE' });
            await cargarHorarios();
        }

        function limpiarFormulario() {
            document.getElementById('form-horario').reset();
            document.getElementById('edit-key').value = '';
            document.getElementById('btn-texto').textContent = 'Guardar Configuración';
            inicializarDias();
        }

        // Inicializar
        window.onload = async () => {
            await cargarHorarios();
            await inicializarDias();
            document.getElementById('form-horario').addEventListener('submit', guardarHorario);
        };
    </script>

    <!-- ✅ Botón flotante sin espacios -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('btn-menu-flotante')) return;
            const btn = document.createElement('button');
            btn.id = 'btn-menu-flotante';
            btn.textContent = '☰ Menú';
            btn.onclick = () => window.location.href = 'https://rodolfooscarfernandezlosain-ui.github.io/gestion-horarios/';
            btn.style.cssText = 'position:fixed;top:20px;right:20px;z-index:999;padding:12px;background:#2980b9;color:white;border:none;border-radius:6px;cursor:pointer;';
            document.body.appendChild(btn);
        });
    </script>
</body>
</html>
